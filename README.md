# Backend University Project

**Описание проекта**: Учебное веб-приложение на Go для приёма и обработки пользовательских форм (JSON и XML), интегрированное с фронт-эндом. Создано без использования фреймворков, демонстрирует принципы REST API, валидации, прогрессивного улучшения и JWT-аутентификации.

---

## Содержание

- [Цели и задачи](#цели-и-задачи)
- [Возможности](#возможности)
- [Структура проекта](#структура-проекта)
- [Установка и запуск](#установка-и-запуск)
- [API и маршруты](#api-и-маршруты)
- [Клиентский скрипт (forma.js)](#клиентский-скрипт-formajs)
- [Валидация данных](#валидация-данных)
- [Аутентификация и безопасность](#аутентификация-и-безопасность)
- [Работа с базой данных](#работа-с-базой-данных)
- [Инициализация базы данных](#инициализация-базы-данных)
- [Зависимости проекта](#зависимости-проекта)
- [Docker Compose](#docker-compose)
- [Корректное завершение работы](#корректное-завершение-работы)

---

## Цели и задачи

Проект реализован в рамках курса «Разработка пользовательского WEB-интерфейса» и включает:

- Интеграцию со статическим сайтом ([https://drupal-coding.com/](https://drupal-coding.com/)).
- Создание REST-сервиса на чистом Go (stdlib).
- Приём данных в формате JSON и form-urlencoded.
- Разделение действий для авторизованных и неавторизованных пользователей через JWT.
- Принцип прогрессивного улучшения (AJAX и классический POST).

---

## Возможности

- **Приём данных формы** (`POST /api/form`) в формате JSON или XML.
- **Регистрация и авторизация** пользователей через JWT.
- **Редактирование профиля** с ограничением изменения `username` и `password`.
- **Клиентская и серверная валидация** полей формы.
- **Прогрессивное улучшение**: поддержка работы с и без JavaScript.

---

## Структура проекта

```text
backend/
├── cmd/backend/            # main.go — точка входа, graceful shutdown
├── internal/
│   ├── database/           # Работа с базой данных PostgreSQL
│   ├── server/             # HTTP-сервер, роутинг, middleware
│   └── types/              # Структуры данных и утилиты
├── db/                     # Инициализация схемы БД
├── static/                 # HTML, CSS, JS файлы
├── Dockerfile              # Сборка контейнера приложения
├── docker-compose.yaml     # Конфигурация развёртывания
├── .env.example            # Шаблон настроек окружения
├── go.mod                  # Модули Go
└── README.md               # Документация проекта
```

---

## Установка и запуск

1. Клонировать репозиторий:
   ```bash
   git clone https://github.com/C4erries/backend.git
   cd backend
   ```
2. Настроить окружение:
   ```bash
   cp .env.example .env
   # Отредактировать переменные: POSTGRES_HOST, POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB, APP_PORT, SALT
   ```
3. Запустить приложение:
   - Локально:
     ```bash
     go build -o backend ./cmd/backend
     ./backend
     ```
   - Через Docker Compose:
     ```bash
     docker-compose up --build
     ```
4. Открыть сайт: [http://localhost:${APP_PORT}](http://localhost:${APP_PORT}).

---

## API и маршруты

| Метод | Путь                | Описание                          |
|:-----:|---------------------|-----------------------------------|
| GET   | `/`                  | Домашняя страница                 |
| POST  | `/process/register`  | Регистрация нового пользователя   |
| POST  | `/process/profile`   | Обновление профиля пользователя   |
| GET   | `/profile`           | Просмотр профиля                  |
| POST  | `/login`             | Аутентификация                    |
| GET   | `/exit`              | Выход из системы                  |
| GET   | `/static/...`        | Статические файлы                 |

---

## Клиентский скрипт (forma.js)

- **HTML-форма** с id="forma".
- При загрузке страницы добавляются блоки для ошибок.
- Отправка формы через JavaScript (`fetch`) с валидацией.
- При ошибках выводятся сообщения рядом с полями.
- При отключённом JS используется стандартный POST.

---

## Валидация данных

Общие правила валидации на клиенте и сервере:

| Поле     | Правила                                       |
|----------|-----------------------------------------------|
| Fio      | 3 слова, кириллица или латиница, пробелы       |
| Tel      | Формат: + и 1–29 цифр                         |
| Email    | Стандартный формат адреса электронной почты   |
| Date     | Формат `YYYY-MM-DD`, проверка валидности даты  |
| Gender   | Только `Male` или `Female`                    |
| Favlangs | Массив ID языков (целые числа 1–11)           |
| Bio      | Текст, допускающий буквы, цифры, знаки        |
| Familiar | Обязательная отметка чекбокса                 |

Ошибки собираются в структуре `types.FormErrors`.

---

## Аутентификация и безопасность

- **Пароли** хешируются через bcrypt с солью.
- **JWT-токены** создаются и проверяются (HS256, срок действия 7 дней + 10 минут).
- **Middleware**:
  - Добавление CORS-заголовков.
  - Логирование запросов.
  - Проверка токенов авторизации.

---

## Работа с базой данных

**internal/database**:

- `Connect()` — подключение к PostgreSQL.
- `MustClose()` — закрытие соединения.
- Операции: запись/обновление формы, проверка пользователя, получение профиля.

---

## Инициализация базы данных

Файл `db/db_init.sql` содержит создание таблиц:

- `forms`
- `langs`
- `favlangs`
- `userinfo`

а также предзаполнение таблицы языков программирования.

---

## Зависимости проекта

```go
module backend

go 1.23.0

toolchain go1.23.4

require (
  github.com/golang-jwt/jwt/v5 v5.2.1
  github.com/lib/pq v1.10.9
  golang.org/x/crypto v0.36.0
)
```

---

## Docker Compose

`docker-compose.yaml` описывает два сервиса:

1. **app**
   - Сборка из локальной папки.
   - Проброс порта `${APP_PORT}`.
   - Зависит от сервиса `db` (ожидание готовности БД).
   - Подключение папки `./static` для статики.

2. **db**
   - Образ `postgres:16.0`.
   - Переменные окружения для БД.
   - Инициализация схемы при старте.
   - Healthcheck с помощью `pg_isready`.

### Запуск через Docker Compose

```bash
docker-compose up --build
```

Для остановки контейнеров — `CTRL+C`. Данные сохраняются в томе `db-data`.

---

## Корректное завершение работы

В `main.go` реализована обработка сигналов:

```go
signal.Notify(stop, syscall.SIGTERM, syscall.SIGINT)
<-stop
database.MustClose()
```

Обеспечивает graceful shutdown при остановке приложения.

---
